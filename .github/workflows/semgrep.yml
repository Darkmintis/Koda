name: "Semgrep - Advanced Static Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '0 4 * * 0' # Weekly on Sunday at 4 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  semgrep:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    container:
      image: returntocorp/semgrep:1.95.0

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep Analysis (SARIF)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --config=p/cwe-top-25 \
            --sarif \
            --output=semgrep-results.sarif \
            --exclude="**/build/**" \
            --exclude="**/.gradle/**" \
            --exclude="**/node_modules/**" \
            --exclude="**/target/**" \
            --exclude="**/vendor/**" \
            --exclude="**/.clj-kondo/**" \
            --exclude="**/test/**" \
            --max-memory=8192 \
            --timeout=1800 \
            --jobs=4 \
            || true

      - name: Upload Semgrep SARIF Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-analysis'

      - name: Run Semgrep Analysis (JSON Report)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/security-audit \
            --json \
            --output=semgrep-report.json \
            --exclude="**/build/**" \
            --exclude="**/.gradle/**" \
            --exclude="**/node_modules/**" \
            --exclude="**/target/**" \
            --exclude="**/vendor/**" \
            --exclude="**/.clj-kondo/**" \
            --exclude="**/test/**" \
            --max-memory=8192 \
            --timeout=1800 \
            --jobs=4 \
            || true

      - name: Upload Semgrep Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-analysis-report
          path: |
            semgrep-results.sarif
            semgrep-report.json
          retention-days: 30

      - name: Generate Analysis Summary
        if: always()
        run: |
          echo "## ðŸ” Semgrep Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "semgrep-report.json" ]; then
            FINDINGS=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo "0")
            echo "ðŸ“Š Total Findings: **$FINDINGS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Analysis completed successfully" >> $GITHUB_STEP_SUMMARY
          fi
